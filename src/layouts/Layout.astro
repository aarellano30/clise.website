---
import '../styles/global.css';
import TopBanner from '../components/TopBanner.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FloatingWhatsApp from '../components/FloatingWhatsApp.astro';
import { useTranslations, getAlternatePath } from '../i18n/utils';
import type { Locale } from '../i18n/utils';
import { siteConfig } from '../config';

interface Props {
	title: string;
	description?: string;
	image?: string;
	hideTopBanner?: boolean;
}

const { title, description, image, hideTopBanner } = Astro.props;

const lang = (Astro.currentLocale || 'es') as Locale;
const t = useTranslations(lang);
const currentPath = Astro.url.pathname;
const canonicalUrl = `${siteConfig.url}${currentPath}`;
const ogImage = image || `${siteConfig.url}/og-image.jpg`;
const defaultDescription = description || siteConfig.description[lang];

// Alternate language URL for hreflang
const altLang: Locale = lang === 'es' ? 'en' : 'es';
const altPath = getAlternatePath(currentPath, altLang);
---

<!doctype html>
<html lang={lang}>
<head>
	<meta charset="UTF-8" />
	<meta name="description" content={defaultDescription} />
	<meta name="viewport" content="width=device-width" />

	<!-- Preload fonts to prevent FOUT -->
	<link rel="preload" href="/fonts/inter-latin-opsz-normal.woff2" as="font" type="font/woff2" crossorigin />

	<!-- Preload video poster (LCP element) -->
	<link rel="preload" href="/videos/trimflex-spider-padel-poster.webp" as="image" type="image/webp" />

	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
	<link rel="icon" type="image/png" href="/favicon.png" />
	<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
	<meta name="generator" content={Astro.generator} />
	<title>{title}</title>

	<!-- Canonical -->
	<link rel="canonical" href={canonicalUrl} />

	<!-- hreflang tags for SEO -->
	<link rel="alternate" hreflang={lang} href={`${siteConfig.url}${currentPath}`} />
	<link rel="alternate" hreflang={altLang} href={`${siteConfig.url}${altPath}`} />
	<link rel="alternate" hreflang="x-default" href={`${siteConfig.url}${lang === 'es' ? currentPath : getAlternatePath(currentPath, 'es')}`} />

	<!-- Open Graph -->
	<meta property="og:type" content="website" />
	<meta property="og:url" content={canonicalUrl} />
	<meta property="og:title" content={title} />
	<meta property="og:description" content={defaultDescription} />
	<meta property="og:image" content={ogImage} />
	<meta property="og:locale" content={lang === 'es' ? 'es_MX' : 'en_US'} />
	<meta property="og:locale:alternate" content={lang === 'es' ? 'en_US' : 'es_MX'} />
	<meta property="og:site_name" content={siteConfig.name} />

	<!-- Twitter Card -->
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:title" content={title} />
	<meta name="twitter:description" content={defaultDescription} />
	<meta name="twitter:image" content={ogImage} />

	<!-- JSON-LD Structured Data -->
	<script type="application/ld+json" set:html={JSON.stringify({
		"@context": "https://schema.org",
		"@type": "Organization",
		"name": siteConfig.fullName,
		"url": siteConfig.url,
		"logo": `${siteConfig.url}/favicon.png`,
		"description": siteConfig.shortDescription[lang],
		"address": {
			"@type": "PostalAddress",
			"addressLocality": siteConfig.address.locality,
			"addressRegion": siteConfig.address.region,
			"addressCountry": siteConfig.address.country
		},
		"contactPoint": {
			"@type": "ContactPoint",
			"telephone": siteConfig.contact.phone,
			"contactType": "sales",
			"email": siteConfig.contact.email,
			"availableLanguage": ["Spanish", "English"]
		},
		"sameAs": Object.values(siteConfig.social)
	})} />

	<!-- Dark mode initialization (runs before page renders to prevent flash) -->
	<script is:inline>
		// Default to dark mode if no preference is saved
		const theme = localStorage.getItem('theme') || 'dark';
		if (theme === 'dark') {
			document.documentElement.classList.add('dark');
		}
	</script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
	{!hideTopBanner && <TopBanner />}
	<Header currentPath={currentPath} lang={lang} />

	<slot />

	<Footer lang={lang} />

	<FloatingWhatsApp />

	<!-- Fade in on scroll -->
	<script>
		// Intersection Observer for fade-in animations
		const observerOptions = {
			threshold: 0.1, // Trigger when 10% of element is visible
			rootMargin: '0px 0px -50px 0px' // Trigger slightly before entering viewport
		};

		const observer = new IntersectionObserver((entries) => {
			entries.forEach(entry => {
				if (entry.isIntersecting) {
					entry.target.classList.add('is-visible');
					observer.unobserve(entry.target); // Only animate once
				}
			});
		}, observerOptions);

		// Observe all elements with fade-in classes
		document.addEventListener('DOMContentLoaded', () => {
			const fadeElements = document.querySelectorAll('.fade-in, .fade-in-fast, .fade-in-slow');
			fadeElements.forEach(el => observer.observe(el));
		});
	</script>

	<!-- Preline JavaScript -->
	<script defer src="/js/preline.js"></script>
</body>
</html>
